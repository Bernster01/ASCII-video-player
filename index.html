<!DOCTYPE html>
<html>

<head>
    <title>BAD APPLE</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<style>
    body {
        background: rgb(86, 86, 86);
    }

    .container {
        display: flex;
        flex-wrap: wrap;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        width: 100%;
        height: 100%;
    }

    #c {
        width: auto;
        height: auto;
        background: aliceblue;
        display: none;
    }

    #v {
        visibility: hidden;
    }

    #textRender {
        font-size: 12pt;
        font-family: monospace;
        color:white;
    }
</style>

<body>
    <div class=container>
        <span id=textRender></span>
        <canvas id=c></canvas>
        <div>
            <button id=play-pause>Play/Pause</button>
            <input type=range id=volume min=0 max=100 value=0.1 step=0.1>
            <input type=range id=size min=1 max=4 value=1 step=1>
            <p>Input</p>
            <input type=file id=file accept="video/*">
        </div>

        <video id=v controls loop></video>
    </div>


</body>
<script>
    let pixels = [];
    let size = 1;
    let isPlaying = false;
    function starterFunction() {
        let file = document.getElementById('file');
        let volumeControl = document.getElementById('volume');
        file.addEventListener('change', function () {
            let files = this.files;
            isPlaying = false;
            //Add the video to the video element
            let video = document.getElementById('v');
            video.src = URL.createObjectURL(files[0]);
            video.volume = volumeControl.value;
            video.play();
        });
        let playPause = document.getElementById('play-pause');
        playPause.addEventListener('click', function () {
            let video = document.getElementById('v');
            if (video.paused) {
                video.play();
            } else {
                video.pause();
            }
        });
        volumeControl.addEventListener('change', function () {
            let video = document.getElementById('v');
            video.volume = this.value / 100;
        });
        let v = document.getElementById('v');
        let canvas = document.getElementById('c');
        let context = canvas.getContext('2d');

        let back = document.createElement('canvas');
        let backcontext = back.getContext('2d', {
            willReadFrequently: true
        });
        let cw, ch;

        v.addEventListener('play', function () {
            if (!isPlaying) {
                cw = back.width = canvas.width = v.clientWidth;
                ch = back.height = canvas.height = v.clientHeight;
                isPlaying = true;
            }
            document.getElementById('textRender').style.width = cw + 'px';
            // document.getElementById('textRender').style.height = ch + 'px';

            draw(this, context, backcontext, cw, ch);
        }, false);

    }
    function draw(v, c, bc, w, h) {
        if (v.paused || v.ended) return false;
        bc.drawImage(v, 0, 0, w, h);
        let idata = bc.getImageData(0, 0, w, h);
        let data = idata.data;
        for (let i = 0; i < data.length; i += 4) {
            let r = data[i];
            let g = data[i + 1];
            let b = data[i + 2];
            let brightness = (3 * r + 4 * g + b) >>> 3;
            data[i] = brightness;
            data[i + 1] = brightness;
            data[i + 2] = brightness;
            //Map current brightness to a matrix
            let x = Math.floor(i / 4 % w);
            let y = Math.floor(i / 4 / w);
            pixels[x] = pixels[x] || [];
            pixels[y][x] = brightness;




        }
        idata.data = data;
        c.putImageData(idata, 0, 0);
        drawInNumbers(w);
        setTimeout(() => {
            draw(v, c, bc, w, h);
        }, 0);
    }
    function drawInNumbers(width) {
        //Shrink the pixels array to 1/4 of its size 

        let textRender = document.getElementById('textRender');
        //Shrink the pixels matrix to 1/4 of its size
        let newPixels = [];
        let factor = 4 / size;
        for (let i = 0; i < pixels.length; i += factor) {
            newPixels[i / factor] = [];
            for (let j = 0; j < pixels[i].length; j += factor) {
                newPixels[i / factor][j / factor] = pixels[i][j];
            }
        }


        //Draw the pixels as plain text
        let text = "";
        //Loop through the pixels matrix
        for (let i = 0; i < newPixels.length; i++) {
            for (let j = 0; j < newPixels[i].length; j++) {
                //Get char from brightness
                let char = getChar(newPixels[i][j]);
                text += char;
            }
            //Add a new line
            text += "\n";
        }
        textRender.innerHTML = text;

    }
    function getChar(brightness) {
        //Map brightness to a char from brightest to darkest let chars = [".","~","#","&","@","$","%","*","!",";"];
        let chars = [".","~","#","+","!","0","$","%","&","@"];
        if (brightness <= 0) return chars[0];
        if (brightness >= 255) return chars[chars.length - 1];

        let index = Math.floor(brightness / 255 * chars.length);
        return chars[index];
    }
    document.addEventListener("DOMContentLoaded", starterFunction);
</script>

</html>