<!DOCTYPE html>
<html>

<head>
    <title>BAD APPLE</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<style>
    body {
        background: rgb(0, 0, 0);
    }

    /*Hide scrollbar*/
    body::-webkit-scrollbar {
        display: none;
    }
    /* Hide scrollbar for IE, Edge and Firefox */
    .example {
        -ms-overflow-style: none;
        /* IE and Edge */
        scrollbar-width: none;
        /* Firefox */
    }

    .container {
        display: flex;
        flex-wrap: wrap;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        width: 100%;
        height: 100%;
    }

    #c {
        width: auto;
        height: auto;
        background: aliceblue;
        display: none;
    }

    #v {
        visibility: hidden;
    }

    #textRender {
        font-size: 8pt;
        font-family: monospace;
        ;
        color: white;
        overflow: hidden;
        border: 0.5em solid rgb(186, 186, 186);
        border-radius: 1em;
        background-color: rgb(57, 57, 57);

    }

    .video-controller {
        position: fixed;
        display: block;
        bottom: 0;
        left: 0;
        /* transform: translate(-50%, -50%); */
        background-color: rgb(172, 172, 172);
        border-radius: 1em;
        padding: 2em;
        opacity: 1;
        transition: opacity 0.5s;

    }
</style>

<body>
    <div class=container>
        <span id=textRender></span>
        <canvas id=c></canvas>


        <video id=v controls loop></video>
    </div>
    <div class=video-controller id=controller>
        <h2>ASCII videoplayer - ver 2.1</h2>
        <button id=play-pause>Play/Pause</button>
        <input type=range id=volume min=0 max=1 value=0.1 step=0.01>
        <input type=range id=size min=0.5 max=4 value=2 step=0.5>
        <p>Input</p>
        <input type=file id=file accept="video/*">
        <input type=checkbox id=invertColor>
    </div>

</body>
<script>
    let pixels = [];
    let size = 2;
    let isPlaying = false;
    let invertedColor = false;
    function starterFunction() {
        let file = document.getElementById('file');
        let volumeControl = document.getElementById('volume');
        document.getElementById('controller').addEventListener('mouseover', function () {
            this.style.opacity = 1;
        });
        document.getElementById('controller').addEventListener('mouseout', function () {
            if (isPlaying) this.style.opacity = 0.25;
        });
        file.addEventListener('change', function () {

            let files = this.files;
            isPlaying = false;
            //Add the video to the video element
            let video = document.getElementById('v');
            if (video.isPlaying) {
                video.stop()
            }
            video.src = URL.createObjectURL(files[0]);
            video.volume = volumeControl.value;
            video.play();
        });
        let playPause = document.getElementById('play-pause');
        playPause.addEventListener('click', function () {
            let video = document.getElementById('v');
            if (video.paused) {
                video.play();
                document.getElementById('controller').style.opacity = 0.25;
            } else {
                video.pause();
                document.getElementById('controller').style.opacity = 1;
            }
        });
        volumeControl.addEventListener('mousemove', function () {
            let video = document.getElementById('v');
            video.volume = this.value;
        });
        let v = document.getElementById('v');
        let canvas = document.getElementById('c');
        let context = canvas.getContext('2d');

        let back = document.createElement('canvas');
        let backcontext = back.getContext('2d', {
            willReadFrequently: true
        });
        let cw, ch;
        let sizeControl = document.getElementById('size');
        sizeControl.addEventListener('mousemove', function () {
            let sizeValue = this.value;

            if (sizeValue == 0.5) sizeValue = 0.5;
            else if (sizeValue % 2 != 0) {
                sizeValue = Math.floor(sizeValue - 0.5);
                if (sizeValue == 1) sizeValue = 1;
                else if (sizeValue % 2 == 0)
                    sizeValue = sizeValue;
                else
                    sizeValue = Math.floor(sizeValue - 0.5);
            }
            if (sizeValue == 0) sizeValue = 0.5;
            if (this.value == 1) sizeValue = 1;
            size = sizeValue
            setCorrectWidth()
        });
        v.addEventListener('play', function () {
            if (!isPlaying) {
                cw = back.width = canvas.width = v.clientWidth;
                ch = back.height = canvas.height = v.clientHeight;
                isPlaying = true;

            }
            document.getElementById('textRender').style.width = cw + 'px';
            document.getElementById('controller').style.opacity = 0;
            // document.getElementById('textRender').style.height = ch + 'px';

            draw(this, backcontext, cw, ch);
            setCorrectWidth();
        }, false);
        document.getElementById('invertColor').addEventListener('change', function () {
            if (this.checked) invertedColor = true; else invertedColor = false;
        });

    }
    function draw(v, bc, w, h) {
        if (v.paused || v.ended) return false;
        bc.drawImage(v, 0, 0, w, h);
        let idata = bc.getImageData(0, 0, w, h);
        let data = idata.data;
        for (let i = 0; i < data.length; i += 4) {
            let r = data[i];
            let g = data[i + 1];
            let b = data[i + 2];
            let brightness = (3 * r + 4 * g + b) >>> 3;
            data[i] = brightness;
            data[i + 1] = brightness;
            data[i + 2] = brightness;
            //Map current brightness to a matrix
            let x = Math.floor(i / 4 % w);
            let y = Math.floor(i / 4 / w);
            pixels[x] = pixels[x] || [];
            pixels[y][x] = brightness;




        }
        idata.data = data;
        drawInNumbers(w);
        setTimeout(() => {
            draw(v, bc, w, h);
        }, 0);
    }
    function drawInNumbers(width) {
        //Shrink the pixels array to 1/4 of its size 

        let textRender = document.getElementById('textRender');
        //Shrink the pixels matrix to 1/4 of its size
        let newPixels = [];
        let factor = 4 / size;
        for (let i = 0; i < pixels.length; i += factor) {
            newPixels[i / factor] = [];
            for (let j = 0; j < pixels[i].length; j += factor) {
                newPixels[i / factor][j / factor] = pixels[i][j];
            }
        }


        //Draw the pixels as plain text
        let text = "";
        //Loop through the pixels matrix
        for (let i = 0; i < newPixels.length; i++) {
            for (let j = 0; j < newPixels[i].length; j++) {
                //Get char from brightness
                let char = getChar(newPixels[i][j]);
                text += char;
            }
            //Add a new line
            text += "\n";
        }
        textRender.innerHTML = text;

    }
    function getChar(brightness) {
        //Map brightness to a char from brightest to darkest let chars = [".","~","#","&","@","$","%","*","!",";"];
        let chars = [".", ",", "~", "#", "+", "!", "0", "$", "%", "&", "@"];
        //let chars = "$@B%8&WM#*oahkbdpqwmZO0QLCJUYXzcvuxrjft/\|()1{}[]?-_+~<>i!lI;:,^`'.".split("");
        //let chars = "$@B%8&WM#*oahkbdpqwmZO0QLCJUYXzcvuxrjft1_+~!I;:,^.".split("");
        if (invertedColor) chars = chars.reverse();
        if (brightness <= 0) return chars[0];
        if (brightness >= 255) return chars[chars.length - 1];

        let index = Math.floor(brightness / 255 * chars.length);
        return chars[index];
    }
    function setCorrectWidth() {
        let pixelCount = pixels[0].length / (4 / size);
        let width = pixelCount * 5.87;
        document.getElementById('textRender').style.width = width + 'px';
    }
    document.addEventListener("DOMContentLoaded", starterFunction);
</script>

</html>